name: C-ray CI

on: [push, pull_request]

jobs:
  build:
    name: ${{ matrix.os }} Build & Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      # Windows needs MSBuild setup
      - name: Setup MSBuild (Windows only)
        if: matrix.os == 'windows-latest'
        uses: microsoft/setup-msbuild@v1.0.2

      - name: Configure CMake
        run: |
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            cmake -S . -B build -G "Visual Studio 17 2022" -A x64
          else
            cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
          fi

      - name: Build
        run: |
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            cmake --build build --config Release
          else
            cmake --build build --config Release -- -j$(nproc)
          fi

      - name: Run Sample Render with Timing
        run: |
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            powershell -Command "Measure-Command { ./build/Release/c-ray.exe -s scenes/cornell.json -o output.png } | Out-File time.txt"
          else
            /usr/bin/time -p ./build/c-ray -s scenes/cornell.json -o output.png 2> time.txt
          fi

      - name: Verify Render Hash
        run: |
          expectedHash="PUT-YOUR-REFERENCE-HASH-HERE"

          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            powershell -Command "
              $hashLine = (Get-FileHash output.png -Algorithm SHA256).Hash;
              if ($hashLine -ne '$expectedHash') {
                Write-Error '❌ Render output hash mismatch!';
                exit 1
              } else {
                Write-Output '✅ Render output matches expected hash.'
              }
            "
          else
            actualHash=$(sha256sum output.png | cut -d ' ' -f1)
            if [ "$actualHash" != "$expectedHash" ]; then
              echo '❌ Render output hash mismatch!'
              exit 1
            else
              echo '✅ Render output matches expected hash.'
            fi
          fi

      - name: Upload Render Output
        uses: actions/upload-artifact@v4
        with:
          name: sample-render-${{ matrix.os }}
          path: output.png

      - name: Upload Timing Log
        uses: actions/upload-artifact@v4
        with:
          name: render-time-${{ matrix.os }}
          path: time.txt